name: Deploy Astro a GitHub Pages y DEV.to

on:
  push:
    branches: [ master ] # O la rama que uses

permissions:
  contents: write # IMPORTANTE: permite a la acción guardar el ID de DEV.to en tu MD
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - name: Install dependencies
        run: npm install
      - name: Type Check
        run: npm run check
      - name: Build Astro
        run: npm run build
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
  publish-devto:
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Prepare articles for DEV.to
        run: |
          mkdir -p devto_dist
          # --- CONFIGURACIÓN ---
          # Cambia esto por tu dominio real
          BASE_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
          REPO_RAW_URL="https://raw.githubusercontent.com/${{ github.repository }}/master"
          
          find src/content/blog -name "*.md" -type f | while read file; do
            filename=$(basename "$file")
            # slug: nombre del archivo sin .md
            slug="${filename%.*}"
            # rel_path: la subcarpeta si existe (ej: posts/)
            rel_path=$(dirname "${file#src/content/blog/}")
            [ "$rel_path" == "." ] && rel_path=""
            
            dest_dir="devto_dist/${rel_path}"
            mkdir -p "$dest_dir"
            dest_file="${dest_dir}/${filename}"
            cp "$file" "$dest_file"

            echo "Procesando canónica y metadatos para: $slug"

            # 1. INYECTAR CANONICAL_URL
            # La construimos asumiendo la estructura estándar de Astro: dominio.com/blog/slug
            # Si tu ruta es distinta, ajusta esta línea:
            CANONICAL="${BASE_URL}/blog/${slug}/"
            # La insertamos justo después del primer ---
            sed -i "2i canonical_url: ${CANONICAL}" "$dest_file"

            # 2. CONVERTIR RUTA DE IMAGEN (Cover Image)
            # De ./portada.png a URL de GitHub Raw
            if [ -n "$rel_path" ]; then
              IMG_PATH="${REPO_RAW_URL}/src/content/blog/${rel_path}"
            else
              IMG_PATH="${REPO_RAW_URL}/src/content/blog"
            fi
            sed -i "s|^cover_image: \./|cover_image: ${IMG_PATH}/|g" "$dest_file"
            
            # 3. LIMPIEZA Y PROTECCIÓN (Tags y Títulos)
            sed -i '/^heroImage:/d' "$dest_file"
            sed -i '/^pubDate:/d' "$dest_file"
            sed -i '/^author:/d' "$dest_file"
            
            # Limpiar Tags: ["a", "b"] -> a, b
            sed -i '/^tags:/s/\[//g; /^tags:/s/\]//g; /^tags:/s/"//g; /^tags:/s/'\''//g' "$dest_file"
            
            # Proteger Título con comillas
            sed -i '/^title:/s/"//g' "$dest_file"
            sed -i 's/^title: \(.*\)/title: "\1"/' "$dest_file"
            
            # Forzar published: false (para que entren como borrador)
            if grep -q "^published:" "$dest_file"; then
              sed -i 's/^published: .*/published: false/' "$dest_file"
            else
              sed -i "3i published: false" "$dest_file"
            fi
          done
      
      - name: Publish to DEV.to
        uses: sinedied/publish-devto@v2
        with:
          devto_key: ${{ secrets.DEVTO_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          files: 'devto_dist/**/*.md'
          branch: 'master'