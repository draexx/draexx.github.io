name: Deploy Astro a GitHub Pages y DEV.to

on:
  push:
    branches: [ master ] # O la rama que uses

permissions:
  contents: write # IMPORTANTE: permite a la acción guardar el ID de DEV.to en tu MD
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - name: Install dependencies
        run: npm install
      - name: Type Check
        run: npm run check
      - name: Build Astro
        run: npm run build
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
  publish-devto:
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Necesario para que la acción sepa qué cambió

      - name: Prepare articles for DEV.to
        run: |
          rm -rf devto_dist
          mkdir -p devto_dist
          
          # 1. Definimos las bases
          # Si tu rama principal es 'main', cambia 'master' por 'main' abajo
          RAW_BASE="https://raw.githubusercontent.com/${{ github.repository }}/master/src/content/blog"
          MY_DOMAIN="https://pedrocarranza.com"
          
          find src/content/blog -name "*.md" -type f | while read file; do
            # Obtenemos la carpeta del post
            folder_path=$(dirname "$file")
            slug=$(basename "$folder_path")
            
            # Si el archivo está en la raíz (no en carpeta), usamos su nombre
            [ "$slug" == "blog" ] && slug=$(basename "$file" .md)
            
            dest_file="devto_dist/${slug}.md"
            cp "$file" "$dest_file"

            echo "--- PROCESANDO: $slug ---"

            # 2. LIMPIEZA TOTAL DE COVER_IMAGE
            # Quitamos comillas (") y (') y luego el ./ para dejar solo el nombre del archivo
            sed -i "/^cover_image:/s/\"//g" "$dest_file"
            sed -i "/^cover_image:/s/'//g" "$dest_file"
            sed -i "s|^cover_image: \./|cover_image: |g" "$dest_file"
            
            # Inyectamos la URL Raw de GitHub (Sin comillas)
            sed -i "s|^cover_image: |cover_image: ${RAW_BASE}/${slug}/|g" "$dest_file"

            # 3. CANONICAL URL (Tu dominio personalizado)
            # Insertamos la URL limpia en la línea 2
            sed -i "2i canonical_url: ${MY_DOMAIN}/blog/${slug}/" "$dest_file"

            # 4. LIMPIEZA DE FRONTMATTER (Astro -> Dev.to)
            sed -i '/^heroImage:/d; /^pubDate:/d; /^author:/d' "$dest_file"
            
            # Limpiar tags (quitar corchetes y comillas)
            sed -i '/^tags:/s/\[//g; /^tags:/s/\]//g; /^tags:/s/"//g; /^tags:/s/'\''//g' "$dest_file"
            
            # Título: Quitamos comillas previas y ponemos comillas dobles limpias
            sed -i '/^title:/s/"//g' "$dest_file"
            sed -i 's/^title: \(.*\)/title: "\1"/' "$dest_file"
            
            # Forzar published: false para que entren como borradores
            if grep -q "^published:" "$dest_file"; then
              sed -i 's/^published: .*/published: false/' "$dest_file"
            else
              sed -i "3i published: false" "$dest_file"
            fi

            # DEBUG para el log de la Action
            echo "Canónica: $(grep 'canonical_url:' "$dest_file")"
            echo "Imagen: $(grep 'cover_image:' "$dest_file")"
          done

      - name: Publish to DEV.to
        run: |
          npx @sinedied/devto-cli@v4 push devto_dist \
            --token ${{ secrets.DEVTO_TOKEN }} \
            --branch master \
            --repo ${{ github.repository }} \
            --reconcile \
            --dry-run=false